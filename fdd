#include <windows.h>
#include <gdiplus.h>
#include <iostream>

#pragma comment (lib,"Gdiplus.lib")

using namespace Gdiplus;

// Глобальные переменные
HINSTANCE hInst;
const wchar_t* szWindowClass = L"DesktopApp";
const wchar_t* szTitle = L"Full Screen Image Viewer";
Image* image = nullptr;
bool isFullScreen = false;
HWND hWndMain;

// Идентификаторы
#define ID_EXIT 1

// Функция для отрисовки
void OnPaint(HDC hdc)
{
    Graphics graphics(hdc);
    if (image)
    {
        graphics.DrawImage(image, 0, 0, image->GetWidth(), image->GetHeight());
    }
}

// Обработчик сообщений
LRESULT CALLBACK WndProc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)
{
    switch (message)
    {
    case WM_PAINT:
        {
            PAINTSTRUCT ps;
            HDC hdc = BeginPaint(hWnd, &ps);
            OnPaint(hdc);
            EndPaint(hWnd, &ps);
        }
        break;
    case WM_KEYDOWN:
        if (wParam == VK_ESCAPE) // Если нажата клавиша ESC
        {
            if (isFullScreen)
            {
                SetWindowLong(hWnd, GWL_STYLE, GetWindowLong(hWnd, GWL_STYLE) | WS_OVERLAPPEDWINDOW);
                SetWindowPos(hWnd, NULL, 100, 100, 800, 600, SWP_NOZORDER | SWP_FRAMECHANGED);
                isFullScreen = false;
            }
        }
        break;
    case WM_COMMAND:
        if (LOWORD(wParam) == ID_EXIT) // ID_EXIT - идентификатор вашей кнопки
        {
            if (isFullScreen)
            {
                SetWindowLong(hWnd, GWL_STYLE, GetWindowLong(hWnd, GWL_STYLE) | WS_OVERLAPPEDWINDOW);
                SetWindowPos(hWnd, NULL, 100, 100, 800, 600, SWP_NOZORDER | SWP_FRAMECHANGED);
                isFullScreen = false;
            }
        }
        break;
    case WM_DESTROY:
        delete image;
        PostQuitMessage(0);
        break;
    default:
        return DefWindowProc(hWnd, message, wParam, lParam);
    }
    return 0;
}

// Функция для создания окна
void InitInstance(HINSTANCE hInstance, int nCmdShow)
{
    hInst = hInstance;
    hWndMain = CreateWindow(szWindowClass, szTitle, WS_OVERLAPPEDWINDOW,
        CW_USEDEFAULT, CW_USEDEFAULT, 800, 600, NULL, NULL, hInstance, NULL);

    if (!hWndMain)
    {
        return;
    }

    ShowWindow(hWndMain, nCmdShow);
    UpdateWindow(hWndMain);
}

// Функция WinMain
int APIENTRY wWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,
    LPWSTR lpCmdLine, int nCmdShow)
{
    // Инициализация GDI+
    GdiplusStartupInput gdiplusStartupInput;
    ULONG_PTR gdiplusToken;
    GdiplusStartup(&gdiplusToken, &gdiplusStartupInput, NULL);

    // Загрузка изображения
    image = new Image(L"Resources\\afrikanskii-lev.orig.jpg");

    // Регистрация класса окна
    WNDCLASS wc = { 0 };
    wc.lpfnWndProc = WndProc;
    wc.hInstance = hInstance;
    wc.lpszClassName = szWindowClass;

    RegisterClass(&wc);

    // Создание окна
    InitInstance(hInstance, nCmdShow);

    // Цикл обработки сообщений
    MSG msg;
    while (GetMessage(&msg, NULL, 0, 0))
    {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    // Завершение GDI+
    GdiplusShutdown(gdiplusToken);
    return (int)msg.wParam;
}
