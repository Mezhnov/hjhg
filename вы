import os
import sqlite3
from flask import Flask, render_template, request, redirect, url_for

# Путь к базе данных SQLite для project1
DATABASE = os.path.join(os.path.dirname(__file__), 'users.db')

# Функция для создания Flask-приложения
def create_app():
    app = Flask(__name__)
    init_db()  # Инициализация базы данных при запуске приложения

    # Главная страница с регистрацией
    @app.route('/')
    def index():
        return render_template("index.html")

    # Обработка регистрации
    @app.route('/register', methods=['POST'])
    def register():
        username = request.form['username']
        password = request.form['password']

        db = get_db()
        db.execute('INSERT INTO users (username, password) VALUES (?, ?)', (username, password))
        db.commit()

        return redirect(url_for('success'))

    @app.route('/success')
    def success():
        return render_template("success.html")

    return app

# Функция для подключения к базе данных
def get_db():
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn

# Функция для инициализации базы данных
def init_db():
    if not os.path.exists(DATABASE):
        with sqlite3.connect(DATABASE) as conn:
            conn.execute('CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, username TEXT, password TEXT)')
            conn.commit()
